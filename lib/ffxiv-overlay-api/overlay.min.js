/*! ffxiv-overlay-plugin v4.0.0 | DSRKafuU (https://dsrkafuu.net) | Copyright (c) MIT License */
var OverlayAPI=function(){"use strict";function e(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function t(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];console.info("[ffxiv-overlay-api]",...t)}function s(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];console.error("[ffxiv-overlay-api]",...t)}const i={extendData:!0,silentMode:!1,seperateLB:!1};function n(e){e=e.toLowerCase();return["acn","arc","lnc","pgl","rog","thm","drg","mnk","nin","sam","rpr","smn","blm","rdm","brd","mch","dnc","blu"].includes(e)?"dps":["cnj","whm","sch","ast","sge"].includes(e)?"healer":["gla","mrd","pld","war","drk","gnb"].includes(e)?"tank":["crp","bsm","arm","gsm","lwr","wvr","alc","cul"].includes(e)?"hand":["bot","fsh","min"].includes(e)?"land":"unknown"}function r(e){return{duration:e.duration||"",durationSeconds:Number.parseInt(e.DURATION),zoneName:e.CurrentZoneName||"",dps:Number.parseInt(e.encdps),last10DPS:Number.parseInt(e.Last10DPS),last30DPS:Number.parseInt(e.Last30DPS),last60DPS:Number.parseInt(e.Last60DPS),hps:Number.parseInt(e.enchps),damage:Number.parseInt(e.damage),healed:Number.parseInt(e.healed)}}function a(e,t){if("CombatData"===e.type){const s={isActive:"true"===e.isActive||!0===e.isActive,encounter:r(e.Encounter),combatant:[]};Object.keys(e.Combatant).filter((t=>Object.prototype.hasOwnProperty.call(e.Combatant,t))).forEach((i=>{if("Limit Break"===i){const n=function(e){let t="";const s=e.maxhit.split("-");s.length>1&&(t=s[0]);let i="";const n=e.maxheal.split("-");return n.length>1&&(i=n[0]),{name:"Limit Break",dps:Number.parseInt(e.encdps),hps:Number.parseInt(e.enchps),damage:Number.parseInt(e.damage),healed:Number.parseInt(e.healed),maxHit:t,maxHeal:i}}(e.Combatant[i]);Number.isNaN(n.dps)||Number.isNaN(n.hps)||(t?s.limitBreak=n:s.combatant.push(n))}else{const t=function(e){let[t,s]=["",0];const i=e.maxhit.split("-");i.length>1&&(t=i[0],s=Number.parseInt(i[1]));let[r,a]=["",0];const o=e.maxheal.split("-");return o.length>1&&(r=o[0],a=Number.parseInt(o[1])),{name:e.name,job:e.Job.toLowerCase(),jobType:n(e.Job),dps:Number.parseInt(e.encdps),last10DPS:Number.parseInt(e.Last10DPS),last30DPS:Number.parseInt(e.Last30DPS),last60DPS:Number.parseInt(e.Last60DPS),hps:Number.parseInt(e.enchps),swings:Number.parseInt(e.swings),hits:Number.parseInt(e.hits),deaths:Number.parseInt(e.deaths),directHits:Number.parseInt(e.DirectHitCount),directHitPct:e.DirectHitPct||"",critHits:Number.parseInt(e.crithits),critHitPct:e["crithit%"]||"",directCritHits:Number.parseInt(e.CritDirectHitCount),directCritHitPct:e.CritDirectHitPct||"",damage:Number.parseInt(e.damage),damageTaken:Number.parseInt(e.damagetaken),damagePct:e["damage%"]||"",healed:Number.parseInt(e.healed),healsTaken:Number.parseInt(e.healstaken),healsPct:e["healed%"]||"",overHeal:Number.parseInt(e.overHeal),overHealPct:e.OverHealPct||"",maxHit:t,maxHitDamage:s,maxHeal:r,maxHealDamage:a}}(e.Combatant[i]);Number.isNaN(t.dps)||Number.isNaN(t.hps)||s.combatant.push(t)}})),e.extendData=s}return e}function o(){if(!arguments.length)return 0;let e=0;for(let t=0;t<arguments.length;t++)e+=(t<0||arguments.length<=t?void 0:arguments[t])||0;return e}function h(){if(!arguments.length)return"0%";let e=0;for(let t=0;t<arguments.length;t++){const s=/([0-9]+)%/gi.exec(t<0||arguments.length<=t?void 0:arguments[t]);s&&s[1]&&(e+=Number.parseInt(s[1])||0)}return"".concat(e,"%")}function l(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];if(!t.length)return{hits:0,hitPct:"0%"};let i=0,n=0;for(let e=0;e<t.length;e++)i+=t[e].hits||0,n+=t[e].totalHits||0;return 0===n||0===i?{hits:0,hitPct:"0%"}:{hits:i,hitPct:"".concat(Math.round(i/n*100),"%")}}function c(){if(!arguments.length)return"0%";let e=0,t=0;for(let s=0;s<arguments.length;s++){const i=/([0-9]+)%/gi.exec(s<0||arguments.length<=s?void 0:arguments[s]);if(i&&i[1]){const s=Number.parseInt(i[1])||0;s>0&&(e+=s,t++)}}return 0===t?"0%":"".concat(Math.round(e/t),"%")}function u(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];if(!t.length)return{hit:"",hitDamage:0};let i={hit:"",hitDamage:0};for(let e=0;e<t.length;e++)t[e].hitDamage>i.hitDamage&&(i=t[e]);return i}class d{constructor(){let s=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(e(this,"_options",{}),e(this,"_subscribers",{}),e(this,"_status",!1),e(this,"_queue",[]),e(this,"_wsURL",Array.from(/[?&]OVERLAY_WS=([^&]+)/.exec(window.location.href)||/[?&]HOST_PORT=([^&]+)/.exec(window.location.href)||[])[1]||""),e(this,"_ws",null),e(this,"_resCounter",0),e(this,"_resPromises",{}),d._instance)return d._instance;this._options=Object.assign(this._options,i,s),this._wsURL?(!this._options.silentMode&&t("initializing api in websocket mode..."),this._initWebSocketMode()):(!this._options.silentMode&&t("initializing api in callback mode..."),this._initCallbackMode()),window.dispatchOverlayEvent=this._triggerEvents.bind(this),d._instance||(d._instance=this)}_sendMessage(e,t){if(this._ws)if(this._status)try{this._ws.send(JSON.stringify(e))}catch(t){return void s(t,e)}else this._queue.push({msg:e});else if(this._status)try{window.OverlayPluginApi.callHandler(JSON.stringify(e),t)}catch(t){return void s(t,e)}else this._queue.push({msg:e,cb:t})}_triggerEvents(e){if(this._subscribers[e.type])for(let t of this._subscribers[e.type])this._options.extendData?t(a(e,this._options.seperateLB)):t(e)}_initWebSocketMode(){let e=this._wsURL;e.includes("/ws")||(e+=(e.endsWith("/")?"":"/")+"ws"),this._ws=new WebSocket(e),this._ws.addEventListener("error",(e=>{s(e)})),this._ws.addEventListener("open",(()=>{for(!this._options.silentMode&&t("websocket connected"),this._status=!0;this._queue.length>0;){const{msg:e}=this._queue.shift();this._sendMessage(e)}!this._options.silentMode&&t("api ready")})),this._ws.addEventListener("message",(e=>{try{e=JSON.parse(e.data)}catch(t){return void s(t,e)}void 0!==e.rseq&&this._resPromises[e.rseq]?(this._resPromises[e.rseq](e),delete this._resPromises[e.rseq]):this._triggerEvents(e)})),this._ws.addEventListener("close",(()=>{this._status=!1,!this._options.silentMode&&t("websocket trying to reconnect..."),setTimeout((()=>{this._initWebSocketMode()}),5e3)}))}_initCallbackMode(){if(!window.OverlayPluginApi||!window.OverlayPluginApi.ready)return!this._options.silentMode&&t("api not ready, trying to reconnect..."),void setTimeout((()=>{this._initCallbackMode()}),5e3);for(this._status=!0,window.__OverlayCallback=this._triggerEvents.bind(this);this._queue.length>0;){const{msg:e,cb:t}=this._queue.shift();this._sendMessage(e,t)}!this._options.silentMode&&t("api ready")}addListener(e,i){this._subscribers[e]||(this._subscribers[e]=[]),"function"==typeof i?(this._subscribers[e].push(i),!this._options.silentMode&&t("listener",i,"of event",e,"added")):s("wrong params",i)}removeListener(e,i){if(this._subscribers[e])if("function"==typeof i){let s=this._subscribers[e].indexOf(i);s>-1&&(this._subscribers[e].splice(s,1),!this._options.silentMode&&t("listener",i,"of event",e,"removed"))}else s("wrong params",i)}removeAllListener(e){this._subscribers[e]&&this._subscribers[e].length>0&&(this._subscribers[e]=[],!this._options.silentMode&&t("all listener of event",e,"removed"))}getAllListener(e){return this._subscribers[e]?this._subscribers[e]:[]}startEvent(){this._sendMessage({call:"subscribe",events:Object.keys(this._subscribers)}),!this._options.silentMode&&t("events",Object.keys(this._subscribers),"started")}endEncounter(){if(this._status)return window.OverlayPluginApi.endEncounter();s("plugin not ready yet"),!this._options.silentMode&&t("encounter ended")}callHandler(e){let t;return this._ws?(e.rseq=this._resCounter++,t=new Promise((t=>{this._resPromises[e.rseq]=t})),this._sendMessage(e)):t=new Promise(((t,i)=>{this._sendMessage(e,(e=>{let n;try{n=null==e?null:JSON.parse(e)}catch(t){return s(t,e),i(t)}return t(n)}))})),t}simulateData(e){this._triggerEvents(e)}}return e(d,"_instance",null),e(d,"mergeCombatant",(function(){for(var e=arguments.length,t=new Array(e),s=0;s<e;s++)t[s]=arguments[s];if(!t.length)return null;const i=[],n=[],r=[],a=[],d=[],m=[],p=[],b=[],g=[],_=[],f=[],v=[],P=[],w=[],N=[],H=[],y=[],D=[],I=[],k=[],S=[];t.forEach((e=>{i.push(e.dps),n.push(e.last10DPS),r.push(e.last30DPS),a.push(e.last60DPS),d.push(e.hps),m.push(e.swings),p.push(e.hits),b.push(e.deaths),g.push({hits:e.directHits,totalHits:e.hits}),_.push({hits:e.critHits,totalHits:e.hits}),f.push({hits:e.directCritHits,totalHits:e.hits}),v.push(e.damage),P.push(e.damageTaken),w.push(e.damagePct),N.push(e.healed),H.push(e.healsTaken),y.push(e.healsPct),D.push(e.overHeal),I.push(e.overHealPct),k.push({hit:e.maxHit,hitDamage:e.maxHitDamage}),S.push({hit:e.maxHeal,hitDamage:e.maxHealDamage})}));const x={name:t[0].name,job:t[0].job,jobType:t[0].jobType,dps:o(...i),last10DPS:o(...n),last30DPS:o(...r),last60DPS:o(...a),hps:o(...d),swings:o(...m),hits:o(...p),deaths:o(...b),damage:o(...v),damageTaken:o(...P),damagePct:h(...w),healed:o(...N),healsTaken:o(...H),healsPct:h(...y),overHeal:o(...D),overHealPct:c(...I)};let M=l(...g);return x.directHits=M.hits,x.directHitPct=M.hitPct,M=l(..._),x.critHits=M.hits,x.critHitPct=M.hitPct,M=l(...f),x.directCritHits=M.hits,x.directCritHitPct=M.hitPct,M=u(...k),x.maxHit=M.hit,x.maxHitDamage=M.hitDamage,M=u(...S),x.maxHeal=M.hit,x.maxHealDamage=M.hitDamage,x})),d}();
